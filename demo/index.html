<!DOCTYPE html>
<html>
	<head>
		<title>RShellJS Demo Application</title>
		<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
		<script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
		<style>
			body {
				margin-top: 25px;
			}
			pre {
			    white-space: pre-wrap;       /* Since CSS 2.1 */
			    white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
			    white-space: -pre-wrap;      /* Opera 4-6 */
			    white-space: -o-pre-wrap;    /* Opera 7 */
			    word-wrap: break-word;       /* Internet Explorer 5.5+ */
			}
			#btnInterrupt {
				margin-right: 10px;
			}
			#output {
				background-color: #eee;
			}
			#command {
				background-color: #FAFFBD;
			}

		</style>
	</head>

	<body>
		<div class="container">
			<div id="commandArea" class="row">
				<div class="col-md-offset-2 col-md-8">
					<form id="commandForm">
						<div class="form-group btn-group-sm">
							<label>Command: </label>
							<input type="submit" class="btn btn-primary pull-right" value="Execute" />
							<br />
							<br />
							<input type="text" class="form-control" id="command" />
					</form>
					<br />

					<div class="row">
						<div class="col-md-6">
							<label>Output: </label>
						</div>
						<div class="col-md-4 btn-group-sm">
							<button id="btnInterrupt" class="btn btn-warning" >Interrupt</button>
							<button id="btnKill" class="btn btn-danger" >Kill</button>
							<button	id="btnClear" class="btn btn-info" >Clear</button>
						</div>
						<div class="col-md-2">
							<label>Status:  </label>
							<span id="status"></span>
						</div>
					</div>
					<br />
					<pre class="form-control" id="output"></pre>
				</div>
			</div>
		</div>

		<script>
			$(function() {
    			var socket = io.connect('http://localhost:5000');

				var $commandForm = $('#commandForm');
				var $command = $('#command');
				var $output = $('#output');
				var $status = $('#status');

				// Submit entered Command to Server
				$commandForm.submit(function(event) {
					event.preventDefault();
					socket.emit('new_command', $command.val());
					$command.val('');
					$output.html('');
				});

				// Listening to incoming Command error output
				socket.on('process_started', function() {
					// Updating Status
					console.log('Process: Started');
					$status.html('Started');
				});

				// Listening to incoming Command error output
				socket.on('process_exited', function(data) {
					// Updating Status
					console.log('Process: Exited');
					if(data.output.signal != null) {
						console.log('\tSignal: ' + data.output.signal);
						$status.html('Killed');
						$('#btnClear').trigger("click");
					} 
					if(data.output.code != null) {
						console.log('\tCode: ' + data.output.code); 
						$status.html('Exited (' + data.output.code + ')');
					}
				});

				// Listening to incoming Command standard output
				socket.on('process_running', function(data) {
					// Display received Command output
					$output.append(arrayBufferToString(data.output));
					// Autosize HTML output node to fit text
					$output.height( $command.height() );
					$output.height( $output[0].scrollHeight );
					// Updating Status
					console.log('Process: Running');
					$status.html('Running');
				});

				// Listening to incoming Command error output
				socket.on('process_stdout_error', function(err) {
					// Updating Status
					console.log('STDOUT: Error');
				});

				// Listening to incoming Command error output
				socket.on('process_stdout_closed', function(err) {
					// Updating Status
					console.log('STDOUT: Closed');
				});

				// Listening to incoming Command error output
				socket.on('process_stdout_ended', function(err) {
					// Updating Status
					console.log('STDOUT: Ended');
				});

				// Listening to incoming Command error output
				socket.on('process_stderr_error', function(err) {
					// Updating Status
					console.log('STDERR: Error');
				});

				// Listening to incoming Command error output
				socket.on('process_stderr_closed', function(err) {
					// Updating Status
					console.log('STDERR: Closed');
				});

				// Listening to incoming Command error output
				socket.on('process_stderr_ended', function(err) {
					// Updating Status
					console.log('STDERR: Ended');
				});

				// Listening to incoming Command error output
				socket.on('process_detached', function(data) {
					// Updating Status
					console.log('Process: Detached');
					$status.html('Detached');
				});

				// Listening to incoming Command error output
				socket.on('process_failed', function(data) {
					// Updating Status
					console.log('Process: Failed');
					$status.html('Failed');
				});


				$("#btnClear").click(function() {
					// Autosize HTML output node to fit text
					$output.html("");
					$output.height( $command.height() );
				});

				$("#btnInterrupt").click(function() {					
					socket.emit('interrupt_command');
				});

				$("#btnKill").click(function() {					
					socket.emit('kill_command');
				});

				// Convert Received ArrayBuffer to a String
				function arrayBufferToString(buffer){
				    var bufView = new Uint8Array(buffer);
				    var length = bufView.length;
				    var result = '';
				    var addition = Math.pow(2,8)-1;

				    for(var i = 0; i<length; i+=addition){
				        if(i + addition > length){
				            addition = length - i;
				        }
				        result += String.fromCharCode.apply(null, bufView.subarray(i,i+addition));
				    }

				    return result;
				}
			});
		</script>
	</body>
</html>
